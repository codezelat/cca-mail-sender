{% extends "base.html" %} {% block layout %}
<div class="min-h-screen bg-black/50">
  <!-- Top Navigation -->
  <nav
    class="border-b border-gray-800 bg-black/40 backdrop-blur-xl sticky top-0 z-40"
  >
    <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
      <div class="flex items-center gap-8">
        <div class="flex items-center gap-3">
          <img
            src="https://cca.it.com/wp-content/uploads/2025/11/cca-logo-768x768.png"
            alt="Logo"
            class="h-8 w-8 rounded-lg shadow-lg shadow-purple-900/20"
          />
          <span class="font-semibold text-sm tracking-wide text-gray-200"
            >CCA Campaign Manager</span
          >
        </div>
        <div class="hidden md:flex items-center gap-6 text-sm font-medium">
          <button
            id="nav-dashboard"
            onclick="switchView('dashboard')"
            class="text-purple-400 font-semibold transition-colors"
          >
            Dashboard
          </button>
          <button
            id="nav-contacts"
            onclick="switchView('contacts')"
            class="text-gray-400 hover:text-white transition-colors"
          >
            Contacts
          </button>
        </div>
      </div>
      <button
        onclick="logout()"
        class="text-sm text-gray-400 hover:text-red-400 transition-colors flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-white/5"
      >
        <span>Sign Out</span>
        <svg
          class="w-4 h-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
          ></path>
        </svg>
      </button>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto px-6 py-8">
    <!-- View 1: Dashboard -->
    <div id="view-dashboard" class="flex flex-col lg:flex-row gap-8">
      <!-- Left Column: Main Content -->
      <div class="flex-1 space-y-6">
        <!-- Quick Stats Row -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <!-- Total -->
          <div
            class="bg-gray-900/40 border border-white/5 rounded-xl p-5 backdrop-blur-sm hover:bg-gray-900/60 transition-colors group"
          >
            <div
              class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1 group-hover:text-gray-400"
            >
              Total Imported
            </div>
            <div
              class="text-2xl font-bold text-white tracking-tight"
              id="stat-total"
            >
              {{ stats.total if stats else 0 }}
            </div>
          </div>

          <!-- Pending -->
          <div
            class="bg-gray-900/40 border border-white/5 rounded-xl p-5 backdrop-blur-sm hover:bg-gray-900/60 transition-colors group"
          >
            <div
              class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1 group-hover:text-yellow-500/80"
            >
              Queue Pending
            </div>
            <div
              class="text-2xl font-bold text-yellow-500 tracking-tight"
              id="stat-pending"
            >
              {{ stats.pending if stats else 0 }}
            </div>
          </div>

          <!-- Sent -->
          <div
            class="bg-gray-900/40 border border-white/5 rounded-xl p-5 backdrop-blur-sm hover:bg-gray-900/60 transition-colors group"
          >
            <div
              class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1 group-hover:text-green-500/80"
            >
              Sent Successfully
            </div>
            <div
              class="text-2xl font-bold text-green-500 tracking-tight"
              id="stat-sent"
            >
              {{ stats.sent if stats else 0 }}
            </div>
          </div>

          <!-- Failed -->
          <div
            class="bg-gray-900/40 border border-white/5 rounded-xl p-5 backdrop-blur-sm hover:bg-gray-900/60 transition-colors group"
          >
            <div
              class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-1 group-hover:text-red-500/80"
            >
              Failed
            </div>
            <div
              class="text-2xl font-bold text-red-500 tracking-tight"
              id="stat-failed"
            >
              {{ stats.failed if stats else 0 }}
            </div>
          </div>
        </div>

        <!-- Usage Limits Card -->
        <div
          class="bg-gray-900/40 border border-white/5 rounded-xl p-6 backdrop-blur-sm"
        >
          <h3
            class="text-base font-semibold text-white mb-4 flex items-center gap-2"
          >
            <svg
              class="w-5 h-5 text-gray-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 10V3L4 14h7v7l9-11h-7z"
              ></path>
            </svg>
            Usage Limits
          </h3>
          <div class="grid md:grid-cols-2 gap-8">
            <!-- Hourly Limit -->
            <div class="space-y-2">
              <div class="flex justify-between items-end">
                <span class="text-sm text-gray-400">Hourly Rate</span>
                <div class="text-right">
                  <span id="stat-used-hour" class="text-lg font-bold text-white"
                    >0</span
                  >
                  <span class="text-sm text-gray-600 font-medium"
                    >/ <span id="stat-limit-hour">20</span></span
                  >
                </div>
              </div>
              <div class="h-2 bg-gray-800 rounded-full overflow-hidden">
                <div
                  id="bar-used-hour"
                  class="h-full bg-blue-500 rounded-full transition-all duration-500"
                  style="width: 0%"
                ></div>
              </div>
            </div>

            <!-- Daily Limit -->
            <div class="space-y-2">
              <div class="flex justify-between items-end">
                <span class="text-sm text-gray-400">Daily Quota</span>
                <div class="text-right">
                  <span
                    id="stat-used-today"
                    class="text-lg font-bold text-white"
                    >0</span
                  >
                  <span class="text-sm text-gray-600 font-medium"
                    >/ <span id="stat-limit-today">300</span></span
                  >
                </div>
              </div>
              <div class="h-2 bg-gray-800 rounded-full overflow-hidden">
                <div
                  id="bar-used-today"
                  class="h-full bg-purple-500 rounded-full transition-all duration-500"
                  style="width: 0%"
                ></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Activities -->
        <div
          class="bg-gray-900/40 border border-white/5 rounded-xl overflow-hidden backdrop-blur-sm flex-1 min-h-[400px] flex flex-col"
        >
          <div
            class="px-6 py-4 border-b border-white/5 flex justify-between items-center bg-white/[0.02]"
          >
            <div class="flex items-center gap-4">
              <h3 class="text-base font-semibold text-white">Live Activity</h3>
              <div class="flex items-center gap-2 text-xs">
                <select
                  id="activity-sort"
                  onchange="changeActivitySort()"
                  class="bg-gray-800 text-gray-300 border border-gray-700 rounded px-2 py-1 focus:outline-none focus:border-purple-500"
                >
                  <option value="status_priority">Status Priority</option>
                  <option value="recent">Recently Updated</option>
                  <option value="newest">Newest First</option>
                </select>
                <select
                  id="activity-limit"
                  onchange="changeActivityLimit()"
                  class="bg-gray-800 text-gray-300 border border-gray-700 rounded px-2 py-1 focus:outline-none focus:border-purple-500"
                >
                  <option value="25">25 per page</option>
                  <option value="50" selected>50 per page</option>
                  <option value="100">100 per page</option>
                  <option value="200">200 per page</option>
                </select>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="relative flex h-2 w-2">
                <span
                  class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"
                ></span>
                <span
                  class="relative inline-flex rounded-full h-2 w-2 bg-green-500"
                ></span>
              </span>
              <span
                class="text-xs text-gray-500 uppercase tracking-wider font-medium"
                >Live</span
              >
            </div>
          </div>
          <div class="overflow-x-auto flex-1">
            <table class="w-full text-left text-sm">
              <thead
                class="bg-gray-900/50 text-gray-500 uppercase font-medium text-xs border-b border-white/5"
              >
                <tr>
                  <th class="px-6 py-3 font-medium">Email</th>
                  <th class="px-6 py-3 font-medium">Name</th>
                  <th class="px-6 py-3 font-medium">Status</th>
                  <th class="px-6 py-3 font-medium">Time</th>
                  <th class="px-6 py-3 font-medium text-right">Action</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-white/5" id="activity-table-body">
                <!-- JS will populate -->
                <tr>
                  <td colspan="5" class="px-6 py-8 text-center text-gray-600">
                    Loading activity...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <!-- Pagination Controls -->
          <div
            class="px-6 py-4 border-t border-white/5 bg-white/[0.02] flex items-center justify-between"
          >
            <div class="text-sm text-gray-400">
              <span id="activity-showing">Showing 0 of 0</span>
            </div>
            <div class="flex items-center gap-2">
              <button
                id="activity-prev"
                onclick="changeActivityPage(-1)"
                class="px-3 py-1 text-xs font-medium text-gray-400 hover:text-white bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
              >
                Previous
              </button>
              <span class="text-xs text-gray-500 px-2">
                Page <span id="activity-current-page">1</span> of
                <span id="activity-total-pages">1</span>
              </span>
              <button
                id="activity-next"
                onclick="changeActivityPage(1)"
                class="px-3 py-1 text-xs font-medium text-gray-400 hover:text-white bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
              >
                Next
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Controls -->
      <div class="w-full lg:w-96 space-y-6">
        <!-- Import Card -->
        <div
          class="bg-gray-900/40 border border-white/5 rounded-xl p-6 backdrop-blur-sm"
        >
          <h3 class="text-base font-semibold text-white mb-4">
            Import Contacts
          </h3>
          <div
            id="drop-zone"
            class="border-2 border-dashed border-gray-700 hover:border-blue-500/50 hover:bg-blue-500/5 rounded-xl p-8 text-center transition-all cursor-pointer group"
          >
            <div
              class="h-10 w-10 bg-gray-800 rounded-lg flex items-center justify-center mx-auto mb-3 group-hover:bg-blue-500/20 transition-colors"
            >
              <svg
                class="w-5 h-5 text-gray-400 group-hover:text-blue-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                ></path>
              </svg>
            </div>
            <p class="text-gray-300 font-medium text-sm">Upload CSV or Excel</p>
            <p class="text-xs text-gray-500 mt-1">
              Drag & drop or click to browse
            </p>

            <div id="upload-progress" class="hidden mt-4">
              <div class="bg-gray-800 h-1 rounded-full overflow-hidden">
                <div
                  class="bg-blue-500 h-full w-1/2 animate-[shimmer_1s_infinite]"
                ></div>
              </div>
              <p class="text-xs text-gray-500 mt-2">Processing...</p>
            </div>
          </div>
          <input
            type="file"
            id="file-upload"
            class="hidden"
            accept=".xlsx, .xls, .csv"
          />
        </div>

        <!-- Settings Card -->
        <div
          class="bg-gray-900/40 border border-white/5 rounded-xl p-6 backdrop-blur-sm sticky top-24"
        >
          <h3 class="text-base font-semibold text-white mb-6">Configuration</h3>
          <form id="settings-form" class="space-y-4">
            <!-- API Key -->
            <div class="space-y-1.5">
              <label
                class="text-xs font-medium text-gray-500 uppercase tracking-wider"
                >Brevo API Key</label
              >
              <input
                type="password"
                name="brevo_api_key"
                value="{{ settings.brevo_api_key or '' }}"
                class="w-full bg-black/50 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-700"
                placeholder="xkeysib-..."
                required
              />
            </div>

            <!-- Sender Info -->
            <div class="grid grid-cols-2 gap-4">
              <div class="space-y-1.5">
                <label
                  class="text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >From Email</label
                >
                <input
                  type="email"
                  name="sender_email"
                  value="{{ settings.sender_email or '' }}"
                  class="w-full bg-black/50 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-700"
                  placeholder="you@domain.com"
                  required
                />
              </div>
              <div class="space-y-1.5">
                <label
                  class="text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >From Name</label
                >
                <input
                  type="text"
                  name="sender_name"
                  value="{{ settings.sender_name or '' }}"
                  class="w-full bg-black/50 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-700"
                  placeholder="Marketing"
                />
              </div>
            </div>

            <!-- Subject -->
            <div class="space-y-1.5">
              <label
                class="text-xs font-medium text-gray-500 uppercase tracking-wider"
                >Subject Line</label
              >
              <input
                type="text"
                name="subject"
                value="{{ settings.subject or 'Campaign Update' }}"
                class="w-full bg-black/50 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-gray-700"
              />
            </div>

            <!-- Template Selection -->
            <div class="space-y-1.5">
              <label
                class="text-xs font-medium text-gray-500 uppercase tracking-wider"
                >Email Template</label
              >
              <div class="flex gap-2">
                <div class="relative flex-1">
                  <select
                    name="selected_template"
                    id="selected_template"
                    class="w-full appearance-none bg-black/50 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all cursor-pointer"
                  >
                    <option value="">Loading templates...</option>
                  </select>
                  <div
                    class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500"
                  >
                    <svg
                      class="fill-current h-4 w-4"
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 20 20"
                    >
                      <path
                        d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"
                      />
                    </svg>
                  </div>
                </div>
                <button
                  type="button"
                  onclick="document.getElementById('template-upload').click()"
                  class="bg-white/5 hover:bg-white/10 border border-white/10 text-white p-2 rounded-lg transition-colors flex-shrink-0"
                  title="Upload New Template"
                >
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4v16m8-8H4"
                    ></path>
                  </svg>
                </button>
                <input
                  type="file"
                  id="template-upload"
                  class="hidden"
                  accept=".html"
                  onchange="uploadTemplate(this)"
                />
              </div>
            </div>

            <!-- Limits -->
            <div class="grid grid-cols-2 gap-4">
              <div class="space-y-1.5">
                <label
                  class="text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >Hourly Limit</label
                >
                <input
                  type="number"
                  name="hourly_limit"
                  value="{{ settings.hourly_limit }}"
                  class="w-full bg-black/50 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all"
                />
              </div>
              <div class="space-y-1.5">
                <label
                  class="text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >Daily Limit</label
                >
                <input
                  type="number"
                  name="daily_limit"
                  id="daily_limit_input"
                  value="{{ settings.daily_limit }}"
                  class="w-full bg-black/50 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all"
                />
              </div>
            </div>

            <button
              type="submit"
              class="w-full bg-white text-black font-semibold h-10 rounded-lg hover:bg-gray-200 transition-all shadow-[0_0_15px_rgba(255,255,255,0.1)] active:scale-[0.98] mt-2"
            >
              Save Configuration
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- View 2: Contact Manager (Hidden by default) -->
    <div id="view-contacts" class="hidden space-y-6">
      <div
        class="bg-gray-900/40 border border-white/5 rounded-xl border-gray-800 overflow-hidden backdrop-blur-sm"
      >
        <!-- Toolbar -->
        <div
          class="px-6 py-4 border-b border-white/5 flex flex-col md:flex-row justify-between items-center gap-4 bg-white/[0.02]"
        >
          <div class="relative w-full md:w-64">
            <input
              type="text"
              id="contact-search"
              placeholder="Search contacts..."
              class="w-full bg-black/50 border border-white/10 rounded-lg pl-10 pr-4 py-2 text-sm text-white focus:outline-none focus:border-blue-500 transition-all"
              oninput="debounceSearch()"
            />
            <svg
              class="w-4 h-4 text-gray-500 absolute left-3 top-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              ></path>
            </svg>
          </div>
          <div class="flex items-center gap-3">
            <button
              onclick="loadContacts()"
              class="p-2 text-gray-400 hover:text-white transition-colors bg-white/5 rounded-lg border border-white/5"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                ></path>
              </svg>
            </button>
            <button
              onclick="deleteAllContacts()"
              class="text-sm bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/20 px-4 py-2 rounded-lg font-medium transition-all"
            >
              Delete All
            </button>
          </div>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto min-h-[400px]">
          <table class="w-full text-left text-sm">
            <thead
              class="bg-gray-900/50 text-gray-500 uppercase font-medium text-xs border-b border-white/5"
            >
              <tr>
                <th class="px-6 py-3 font-medium">Name</th>
                <th class="px-6 py-3 font-medium">Email</th>
                <th class="px-6 py-3 font-medium">Status</th>
                <th class="px-6 py-3 font-medium text-right">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-white/5" id="contacts-table-body">
              <tr>
                <td colspan="4" class="px-6 py-8 text-center text-gray-600">
                  Loading...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div
          class="px-6 py-4 border-t border-white/5 flex justify-between items-center bg-white/[0.02]"
        >
          <span class="text-sm text-gray-500" id="pagination-info"
            >Page 1 of 1</span
          >
          <div class="flex gap-2">
            <button
              id="btn-prev"
              onclick="changePage(-1)"
              class="px-3 py-1 text-sm bg-white/5 hover:bg-white/10 rounded-lg text-white disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Previous
            </button>
            <button
              id="btn-next"
              onclick="changePage(1)"
              class="px-3 py-1 text-sm bg-white/5 hover:bg-white/10 rounded-lg text-white disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Next
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div
  id="edit-modal"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300"
>
  <div
    class="bg-gray-900 border border-gray-800 rounded-xl p-6 w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-300"
    id="edit-modal-content"
  >
    <h3 class="text-lg font-semibold text-white mb-4">Edit Contact</h3>
    <form id="edit-form" class="space-y-4">
      <input type="hidden" name="contact_id" id="edit-id" />
      <div>
        <label class="block text-sm font-medium text-gray-400 mb-1">Name</label>
        <input
          type="text"
          name="name"
          id="edit-name"
          class="w-full bg-black border border-gray-700 rounded-lg px-4 py-2 text-white focus:border-blue-500 focus:outline-none"
        />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-400 mb-1"
          >Email</label
        >
        <input
          type="email"
          name="email"
          id="edit-email"
          class="w-full bg-black border border-gray-700 rounded-lg px-4 py-2 text-white focus:border-blue-500 focus:outline-none"
        />
      </div>
      <div class="flex justify-end gap-3 pt-4">
        <button
          type="button"
          onclick="closeEditModal()"
          class="px-4 py-2 text-sm text-gray-400 hover:text-white"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="px-4 py-2 text-sm bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-medium"
        >
          Save Changes
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Toast Container -->
<div
  id="toast-container"
  class="fixed top-6 right-6 z-50 flex flex-col space-y-4 pointer-events-none"
></div>

<script>
  // --- Auth & Globals ---
  const token = localStorage.getItem("token");
  if (!token) window.location.href = "/login";
  const headers = { Authorization: `Bearer ${token}` };

  // --- State ---
  let currentPage = 1;
  let currentLimit = 50;
  let currentSearch = "";
  let searchTimeout = null;

  // --- Navigation ---
  function switchView(view) {
    document.getElementById("view-dashboard").classList.add("hidden");
    document.getElementById("view-contacts").classList.add("hidden");
    document
      .getElementById("nav-dashboard")
      .classList.remove("text-purple-400", "font-semibold");
    document
      .getElementById("nav-contacts")
      .classList.remove("text-purple-400", "font-semibold");
    document.getElementById("nav-dashboard").classList.add("text-gray-400");
    document.getElementById("nav-contacts").classList.add("text-gray-400");

    if (view === "dashboard") {
      document.getElementById("view-dashboard").classList.remove("hidden");
      document
        .getElementById("nav-dashboard")
        .classList.add("text-purple-400", "font-semibold");
      document
        .getElementById("nav-dashboard")
        .classList.remove("text-gray-400");
      updateStats(); // Refresh stats
    } else {
      document.getElementById("view-contacts").classList.remove("hidden");
      document
        .getElementById("nav-contacts")
        .classList.add("text-purple-400", "font-semibold");
      document.getElementById("nav-contacts").classList.remove("text-gray-400");
      loadContacts(); // Load Data
    }
  }

  // --- Toast System ---
  function showToast(title, message, isError = false) {
    const container = document.getElementById("toast-container");
    const toast = document.createElement("div");

    const bgColor = isError
      ? "bg-red-500/10 border-red-500/20"
      : "bg-green-500/10 border-green-500/20";
    const iconColor = isError ? "text-red-400" : "text-green-400";
    const iconSvg = isError
      ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />'
      : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />';

    toast.className = `pointer-events-auto w-80 backdrop-blur-md border ${bgColor} rounded-xl p-4 shadow-2xl transform transition-all duration-500 translate-x-full opacity-0 flex items-start gap-3`;
    toast.innerHTML = `
          <div class="mt-0.5 shrink-0 ${iconColor}"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">${iconSvg}</svg></div>
          <div class="flex-1"><h3 class="text-sm font-medium text-white">${title}</h3><p class="text-sm text-gray-400 mt-1 leading-relaxed">${message}</p></div>
        `;
    container.appendChild(toast);
    requestAnimationFrame(() =>
      toast.classList.remove("translate-x-full", "opacity-0")
    );
    setTimeout(() => {
      toast.classList.add("translate-x-full", "opacity-0");
      setTimeout(() => toast.remove(), 500);
    }, 4000);
  }

  // --- Stats & Activity ---
  // Activity Pagination State
  let activityPage = 1;
  let activityLimit = 50;
  let activitySort = "status_priority";

  async function updateStats() {
    try {
      const response = await fetch("/api/stats", { headers });
      if (response.status === 401) {
        window.location.href = "/login";
        return;
      }
      const data = await response.json();

      // Stats
      document.getElementById("stat-total").textContent = data.total_contacts;
      document.getElementById("stat-pending").textContent = data.pending;
      document.getElementById("stat-sent").textContent = data.sent;
      document.getElementById("stat-failed").textContent = data.failed;

      // Limits View
      document.getElementById("stat-used-hour").textContent =
        document.getElementById("stat-used-hour").textContent =
          data.emails_sent_this_hour;
      document.getElementById("stat-used-today").textContent =
        data.emails_sent_today;

      document.getElementById("stat-limit-hour").textContent =
        data.hourly_limit;
      document.getElementById("stat-limit-today").textContent =
        data.daily_limit;

      // Bars
      const pctHour = Math.min(
        (data.emails_sent_this_hour / data.hourly_limit) * 100,
        100
      );
      const pctDay = Math.min(
        (data.emails_sent_today / data.daily_limit) * 100,
        100
      );
      document.getElementById("bar-used-hour").style.width = `${pctHour}%`;
      document.getElementById("bar-used-today").style.width = `${pctDay}%`;

      updateActivity();
    } catch (e) {
      console.error("Stats error", e);
    }
  }

  async function updateActivity() {
    try {
      const params = new URLSearchParams({
        page: activityPage,
        limit: activityLimit,
        sort_by: activitySort,
      });
      console.log("Fetching activity with:", {
        page: activityPage,
        limit: activityLimit,
        sort_by: activitySort,
      });
      const res = await fetch(`/api/activity?${params}`, { headers });
      const data = await res.json();
      const tbody = document.getElementById("activity-table-body");
      tbody.innerHTML = "";

      if (!data.contacts || data.contacts.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-gray-600 text-sm">No recent activity</td></tr>`;
        document.getElementById("activity-showing").textContent =
          "Showing 0 of 0";
        document.getElementById("activity-current-page").textContent = "1";
        document.getElementById("activity-total-pages").textContent = "1";
        document.getElementById("activity-prev").disabled = true;
        document.getElementById("activity-next").disabled = true;
        return;
      }

      data.contacts.forEach((row) => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-white/[0.02] transition-colors group";

        let statusBadge = "";
        if (row.status === "sent")
          statusBadge =
            '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-500/10 text-green-400 border border-green-500/20">Sent</span>';
        else if (row.status === "failed")
          statusBadge =
            '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-500/10 text-red-400 border border-red-500/20">Failed</span>';
        else if (row.status === "processing")
          statusBadge =
            '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-500/10 text-yellow-500 border border-yellow-500/20 animate-pulse">Sending...</span>';
        else
          statusBadge =
            '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-500/10 text-gray-400 border border-gray-500/20">Pending</span>';

        // Format Time - show different timestamp based on sort
        const sortBy = document.getElementById("activity-sort").value;
        let displayDate;
        if (sortBy === "newest") {
          displayDate = new Date(
            row.created_at.endsWith("Z") ? row.created_at : row.created_at + "Z"
          );
        } else {
          displayDate = new Date(
            row.updated_at.endsWith("Z") ? row.updated_at : row.updated_at + "Z"
          );
        }
        const timeStr = displayDate.toLocaleString([], {
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });

        tr.innerHTML = `
                 <td class="px-6 py-4 text-white font-medium">${row.email}</td>
                 <td class="px-6 py-4 text-gray-400">${row.name || "-"}</td>
                 <td class="px-6 py-4">${statusBadge}</td>
                 <td class="px-6 py-4 text-gray-500 text-xs font-mono">${timeStr}</td>
                 <td class="px-6 py-4 text-right">
                   ${
                     row.status === "failed" || row.status === "sent"
                       ? `<button onclick="resendEmail('${row.email}')" class="text-blue-400 hover:text-white text-xs font-medium opacity-0 group-hover:opacity-100 transition-opacity">Resend</button>`
                       : ""
                   }
                 </td>
               `;
        tbody.appendChild(tr);
      });

      // Update pagination info
      const start = (data.page - 1) * data.limit + 1;
      const end = Math.min(data.page * data.limit, data.total);
      document.getElementById(
        "activity-showing"
      ).textContent = `Showing ${start}-${end} of ${data.total}`;
      document.getElementById("activity-current-page").textContent = data.page;
      document.getElementById("activity-total-pages").textContent = data.pages;

      // Update button states
      document.getElementById("activity-prev").disabled = data.page <= 1;
      document.getElementById("activity-next").disabled =
        data.page >= data.pages;
    } catch (e) {
      console.error(e);
    }
  }

  window.changeActivityPage = function (delta) {
    activityPage += delta;
    if (activityPage < 1) activityPage = 1;
    updateActivity();
  };

  window.changeActivitySort = function () {
    activitySort = document.getElementById("activity-sort").value;
    activityPage = 1; // Reset to first page when sorting changes
    console.log("Sort changed to:", activitySort);
    updateActivity();
  };

  window.changeActivityLimit = function () {
    activityLimit = parseInt(document.getElementById("activity-limit").value);
    activityPage = 1; // Reset to first page when limit changes
    console.log("Limit changed to:", activityLimit);
    updateActivity();
  };

  async function resendEmail(email) {
    if (!confirm(`Resend to ${email}?`)) return;
    try {
      const res = await fetch(`/api/resend/${email}`, {
        method: "POST",
        headers,
      });
      if (res.ok) {
        showToast("Queued", `Resending to ${email}`);
        updateStats();
      } else showToast("Error", "Failed to resend", true);
    } catch (e) {
      showToast("Error", "Network error", true);
    }
  }

  // --- Settings & Init ---
  async function loadSettings() {
    try {
      const res = await fetch("/api/settings", { headers });
      if (res.status === 401) return;
      const data = await res.json();

      const setVal = (n, v) => {
        const el = document.querySelector(`[name="${n}"]`);
        if (el) el.value = v || "";
      };
      setVal("brevo_api_key", data.brevo_api_key);
      setVal("sender_email", data.sender_email);
      setVal("sender_name", data.sender_name);
      setVal("subject", data.subject);
      setVal("hourly_limit", data.hourly_limit);
      setVal("daily_limit", data.daily_limit);

      loadTemplates(data.selected_template);
    } catch (e) {
      console.error(e);
    }
  }

  async function loadTemplates(selected) {
    try {
      const res = await fetch("/api/templates", { headers });
      const data = await res.json();
      const el = document.getElementById("selected_template");
      el.innerHTML = '<option value="">Select template...</option>';
      data.templates.forEach((t) => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        if (t === selected) opt.selected = true;
        el.appendChild(opt);
      });
    } catch (e) {}
  }

  // --- Uploads ---
  const dropZone = document.getElementById("drop-zone");
  const fileInput = document.getElementById("file-upload");

  if (dropZone && fileInput) {
    dropZone.addEventListener("click", () => fileInput.click());
    dropZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropZone.classList.add("border-blue-500");
    });
    dropZone.addEventListener("dragleave", () => {
      dropZone.classList.remove("border-blue-500");
    });
    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropZone.classList.remove("border-blue-500");
      if (e.dataTransfer.files[0]) handleUpload(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener("change", () => {
      if (fileInput.files[0]) handleUpload(fileInput.files[0]);
    });
  }

  // Activity controls event listeners
  document
    .getElementById("activity-sort")
    ?.addEventListener("change", changeActivitySort);
  document
    .getElementById("activity-limit")
    ?.addEventListener("change", changeActivityLimit);

  async function handleUpload(file) {
    const formData = new FormData();
    formData.append("file", file);
    document.getElementById("upload-progress").classList.remove("hidden");

    try {
      const res = await fetch("/api/upload", {
        method: "POST",
        headers,
        body: formData,
      });
      const data = await res.json();
      if (res.ok) {
        showToast("Imported", data.message);
        updateStats();
        // If in contacts view, reload contacts
        if (
          !document.getElementById("view-contacts").classList.contains("hidden")
        ) {
          loadContacts();
        }
      } else showToast("Failed", data.detail || "Error", true);
    } catch (e) {
      showToast("Error", "Network error", true);
    } finally {
      document.getElementById("upload-progress").classList.add("hidden");
    }
  }

  async function uploadTemplate(input) {
    if (!input.files[0]) return;
    const formData = new FormData();
    formData.append("file", input.files[0]);
    try {
      const res = await fetch("/api/templates/upload", {
        method: "POST",
        headers,
        body: formData,
      });
      const data = await res.json();
      if (res.ok) {
        showToast("Uploaded", data.filename);
        loadTemplates(data.filename);
      } else showToast("Failed", data.detail, true);
    } catch (e) {
      showToast("Error", "Network error", true);
    }
    input.value = "";
  }

  document
    .getElementById("settings-form")
    .addEventListener("submit", async (e) => {
      e.preventDefault();
      try {
        const res = await fetch("/api/settings", {
          method: "POST",
          headers,
          body: new FormData(e.target),
        });
        if (res.ok) {
          showToast("Saved", "Configuration updated");
          updateStats();
        } else showToast("Error", "Failed to save", true);
      } catch (e) {
        showToast("Error", "Network error", true);
      }
    });

  // --- Contact Management ---
  function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      currentSearch = document.getElementById("contact-search").value;
      currentPage = 1;
      loadContacts();
    }, 300);
  }

  function changePage(delta) {
    currentPage += delta;
    loadContacts();
  }

  async function loadContacts() {
    const tbody = document.getElementById("contacts-table-body");

    // Show Loading
    // tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-gray-600">Loading...</td></tr>`;

    try {
      const url = `/api/contacts?page=${currentPage}&limit=${currentLimit}&search=${encodeURIComponent(
        currentSearch
      )}`;
      const res = await fetch(url, { headers });
      const data = await res.json();

      tbody.innerHTML = "";
      if (data.contacts.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-gray-600 text-sm">No contacts found</td></tr>`;
      } else {
        data.contacts.forEach((c) => {
          const tr = document.createElement("tr");
          tr.className = "hover:bg-white/[0.02] transition-colors group";

          let statusColor = "text-gray-400";
          if (c.status === "sent") statusColor = "text-green-400";
          if (c.status === "failed") statusColor = "text-red-400";

          tr.innerHTML = `
                        <td class="px-6 py-4 text-white font-medium">${
                          c.name || "-"
                        }</td>
                        <td class="px-6 py-4 text-gray-400">${c.email}</td>
                        <td class="px-6 py-4 uppercase text-xs font-semibold ${statusColor}">${
            c.status
          }</td>
                        <td class="px-6 py-4 text-right gap-2 flex justify-end">
                            <button onclick="openEditModal(${
                              c.id
                            }, '${c.name.replace(/'/g, "\\'")}', '${
            c.email
          }')" class="text-blue-400 hover:text-white px-2 py-1 hover:bg-white/10 rounded transition-colors">Edit</button>
                            <button onclick="deleteContact(${
                              c.id
                            })" class="text-red-400 hover:text-white px-2 py-1 hover:bg-red-500/10 rounded transition-colors">Delete</button>
                        </td>
                    `;
          tbody.appendChild(tr);
        });
      }

      // Pagination Controls
      document.getElementById("pagination-info").textContent = `Page ${
        data.page
      } of ${data.pages || 1} (${data.total} total)`;
      document.getElementById("btn-prev").disabled = data.page <= 1;
      document.getElementById("btn-next").disabled = data.page >= data.pages;
    } catch (e) {
      console.error(e);
      tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-red-400 text-sm">Error loading contacts</td></tr>`;
    }
  }

  // Modal Logic
  function openEditModal(id, name, email) {
    document.getElementById("edit-id").value = id;
    document.getElementById("edit-name").value = name;
    document.getElementById("edit-email").value = email;
    const modal = document.getElementById("edit-modal");
    modal.classList.remove("hidden");
    requestAnimationFrame(() => modal.classList.remove("opacity-0"));
    document.getElementById("edit-modal-content").classList.remove("scale-95");
  }

  function closeEditModal() {
    const modal = document.getElementById("edit-modal");
    modal.classList.add("opacity-0");
    document.getElementById("edit-modal-content").classList.add("scale-95");
    setTimeout(() => modal.classList.add("hidden"), 300);
  }

  document.getElementById("edit-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const id = document.getElementById("edit-id").value;
    const formData = new FormData(e.target);

    try {
      const res = await fetch(`/api/contacts/${id}`, {
        method: "PUT",
        headers,
        body: formData,
      });
      if (res.ok) {
        showToast("Success", "Contact updated");
        closeEditModal();
        loadContacts();
      } else {
        showToast("Error", "Update failed", true);
      }
    } catch (e) {
      showToast("Error", "Network error", true);
    }
  });

  async function deleteContact(id) {
    if (!confirm("Delete this contact?")) return;
    try {
      const res = await fetch(`/api/contacts/${id}`, {
        method: "DELETE",
        headers,
      });
      if (res.ok) {
        showToast("Deleted", "Contact removed");
        loadContacts();
        updateStats();
      } else showToast("Error", "Delete failed", true);
    } catch (e) {
      showToast("Error", "Network error", true);
    }
  }

  async function deleteAllContacts() {
    if (
      !confirm(
        "WARNING: This will delete ALL your contacts. This cannot be undone."
      )
    )
      return;
    try {
      const res = await fetch(`/api/contacts`, { method: "DELETE", headers });
      const data = await res.json();
      if (res.ok) {
        showToast("Cleared", data.message);
        loadContacts();
        updateStats();
      } else showToast("Error", "Process failed", true);
    } catch (e) {
      showToast("Error", "Network error", true);
    }
  }

  function logout() {
    localStorage.removeItem("token");
    window.location.href = "/";
  }

  // Init
  loadSettings();
  switchView("dashboard"); // Start on dashboard
  setInterval(updateStats, 5000);
</script>
{% endblock %} ```
